name: Format IP List

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š7ç‚¹è¿è¡Œï¼ˆUTC 23:00ï¼‰
    - cron: '0 23 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  format-ip:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Create format script
        run: |
          cat > format_ip.py << 'EOF'
          import requests
          from collections import defaultdict

          # ä»ŽæŒ‡å®š URL èŽ·å– IP åˆ—è¡¨
          url = "https://raw.githubusercontent.com/kgdpyeifk/cfipcaiji/refs/heads/main/ip.txt"
          try:
              response = requests.get(url)
              response.raise_for_status()
              ip_list = [line.strip() for line in response.text.splitlines() if line.strip()]
          except requests.exceptions.RequestException as e:
              print(f"èŽ·å–IPåˆ—è¡¨å¤±è´¥: {e}")
              exit(1)

          # ä½¿ç”¨ ip-api.com æŸ¥è¯¢ IP åœ°ç†ä½ç½®
          def get_country_info(ip):
              try:
                  api_url = f"http://ip-api.com/json/{ip}"
                  response = requests.get(api_url, timeout=5).json()
                  if response['status'] == 'success':
                      country = response['country']
                      country_code = response['countryCode'].upper()
                      # ç®€å•æ˜ å°„æ——å¸œï¼ˆä½¿ç”¨ Unicode æ——å¸œç¬¦å·ï¼‰
                      flag_map = {
                          'HK': 'ðŸ‡­ðŸ‡°', 'TW': 'ðŸ‡¹ðŸ‡¼', 'US': 'ðŸ‡ºðŸ‡¸', 'JP': 'ðŸ‡¯ðŸ‡µ', 'SG': 'ðŸ‡¸ðŸ‡¬',
                          'KR': 'ðŸ‡°ðŸ‡·', 'DE': 'ðŸ‡©ðŸ‡ª', 'GB': 'ðŸ‡¬ðŸ‡§', 'FR': 'ðŸ‡«ðŸ‡·', 'CA': 'ðŸ‡¨ðŸ‡¦',
                          'AU': 'ðŸ‡¦ðŸ‡º', 'IN': 'ðŸ‡®ðŸ‡³', 'RU': 'ðŸ‡·ðŸ‡º', 'CN': 'ðŸ‡¨ðŸ‡³'
                      }
                      flag = flag_map.get(country_code, 'ðŸ³ï¸')
                      # ç®€åŒ–çš„ä¸­æ–‡åç§°æ˜ å°„ï¼ˆå¯æ‰©å±•ï¼‰
                      chinese_map = {
                          'HK': 'é¦™æ¸¯', 'TW': 'å°æ¹¾', 'US': 'ç¾Žå›½', 'JP': 'æ—¥æœ¬', 'SG': 'æ–°åŠ å¡',
                          'KR': 'éŸ©å›½', 'DE': 'å¾·å›½', 'GB': 'è‹±å›½', 'FR': 'æ³•å›½', 'CA': 'åŠ æ‹¿å¤§',
                          'AU': 'æ¾³å¤§åˆ©äºš', 'IN': 'å°åº¦', 'RU': 'ä¿„ç½—æ–¯', 'CN': 'ä¸­å›½'
                      }
                      chinese_name = chinese_map.get(country_code, f"æœªçŸ¥({country_code})")
                      return flag, country_code, chinese_name
              except Exception as e:
                  print(f"æŸ¥è¯¢ {ip} å¤±è´¥: {e}")
              return 'ðŸ³ï¸', 'UNK', f"æœªçŸ¥({ip})"

          # å¤„ç† IP åˆ—è¡¨å¹¶ç”Ÿæˆæ ¼å¼åŒ–è¾“å‡º
          country_ips = defaultdict(list)
          for ip in ip_list:
              if ':' in ip:  # ç¡®ä¿æ˜¯ IP:Port æ ¼å¼
                  flag, country_code, chinese_name = get_country_info(ip.split(':')[0])
                  formatted_line = f"{ip}#{flag}{country_code}-{chinese_name}-å¤‡ç”¨"
                  country_ips[country_code].append(formatted_line)

          # é™åˆ¶æ¯ä¸ªå›½å®¶å‰ 10 æ¡
          top10_lines = []
          for country_code in country_ips:
              top10_lines.extend(country_ips[country_code][:10])

          # ä¿å­˜åˆ° top10.txt
          try:
              with open('top10.txt', 'w', encoding='utf-8') as f:
                  f.write('\n'.join(top10_lines) + '\n')
          except IOError as e:
              print(f"å†™å…¥æ–‡ä»¶å¤±è´¥: {e}")
              exit(1)

          print("top10.txt å·²ç”Ÿæˆ")
          EOF

      - name: Run format script
        run: python format_ip.py

      - name: Commit and push changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add top10.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
              echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
              exit 0
          fi
          
          git commit -m "Update top10.txt with formatted IP list"
          git push
