name: Format IP List

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š7ç‚¹è¿è¡Œï¼ˆUTC 23:00ï¼‰
    - cron: '0 23 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  format-ip:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          pip install ip2geotools

      - name: Create format script
        run: |
          cat > format_ip.py << 'EOF'
          import requests
          from collections import defaultdict
          import time
          from ip2geotools.databases.noncommercial import DbIpCity

          # ä»æŒ‡å®š URL è·å– IP åˆ—è¡¨
          url = "https://raw.githubusercontent.com/kgdpyeifk/cfipcaiji/refs/heads/main/ip.txt"
          try:
              response = requests.get(url)
              response.raise_for_status()
              ip_list = [line.strip() for line in response.text.splitlines() if line.strip()]
              print(f"è·å–åˆ° {len(ip_list)} ä¸ª IP: {ip_list[:5]}...")  # è°ƒè¯•è¾“å‡ºå‰5ä¸ªIP
          except requests.exceptions.RequestException as e:
              print(f"è·å–IPåˆ—è¡¨å¤±è´¥: {e}")
              exit(1)

          # ä½¿ç”¨ ip2geotools DbIpCity æŸ¥è¯¢ IP åœ°ç†ä½ç½®
          def get_country_info(ip):
              try:
                  response = DbIpCity.get(ip, api_key='free')
                  country_code = response.country.upper()
                  chinese_map = {
                      'HK': 'é¦™æ¸¯', 'TW': 'å°æ¹¾', 'US': 'ç¾å›½', 'JP': 'æ—¥æœ¬', 'SG': 'æ–°åŠ å¡',
                      'KR': 'éŸ©å›½', 'DE': 'å¾·å›½', 'GB': 'è‹±å›½', 'FR': 'æ³•å›½', 'CA': 'åŠ æ‹¿å¤§',
                      'AU': 'æ¾³å¤§åˆ©äºš', 'IN': 'å°åº¦', 'RU': 'ä¿„ç½—æ–¯', 'CN': 'ä¸­å›½'
                  }
                  flag_map = {
                      'HK': 'ğŸ‡­ğŸ‡°', 'TW': 'ğŸ‡¹ğŸ‡¼', 'US': 'ğŸ‡ºğŸ‡¸', 'JP': 'ğŸ‡¯ğŸ‡µ', 'SG': 'ğŸ‡¸ğŸ‡¬',
                      'KR': 'ğŸ‡°ğŸ‡·', 'DE': 'ğŸ‡©ğŸ‡ª', 'GB': 'ğŸ‡¬ğŸ‡§', 'FR': 'ğŸ‡«ğŸ‡·', 'CA': 'ğŸ‡¨ğŸ‡¦',
                      'AU': 'ğŸ‡¦ğŸ‡º', 'IN': 'ğŸ‡®ğŸ‡³', 'RU': 'ğŸ‡·ğŸ‡º', 'CN': 'ğŸ‡¨ğŸ‡³'
                  }
                  flag = flag_map.get(country_code, 'ğŸ³ï¸')
                  chinese_name = chinese_map.get(country_code, f"æœªçŸ¥({country_code})")
                  print(f"æŸ¥è¯¢ {ip} æˆåŠŸ: {flag}{country_code}-{chinese_name}")
                  time.sleep(0.1)  # å»¶è¿Ÿ 0.1 ç§’
                  return flag, country_code, chinese_name
              except Exception as e:
                  print(f"æŸ¥è¯¢ {ip} å¤±è´¥: {e}, è·³è¿‡æ­¤ IP")
                  time.sleep(0.1)  # å¤±è´¥æ—¶ä¹Ÿå»¶è¿Ÿï¼Œé¿å…èµ„æºç«äº‰
                  return None

          # å¤„ç† IP åˆ—è¡¨å¹¶ç”Ÿæˆæ ¼å¼åŒ–è¾“å‡º
          country_ips = defaultdict(list)
          for ip in ip_list:
              ip_part = ip.split(':')[0] if ':' in ip else ip  # æ”¯æŒçº¯ IP æˆ– IP:Port
              result = get_country_info(ip_part)
              if result:  # ä»…å½“æŸ¥è¯¢æˆåŠŸæ—¶å¤„ç†
                  flag, country_code, chinese_name = result
                  formatted_line = f"{ip}#{flag}{country_code}-{chinese_name}-å¤‡ç”¨"
                  country_ips[country_code].append(formatted_line)
                  print(f"å¤„ç† {ip} -> {formatted_line}")

          # é™åˆ¶æ¯ä¸ªå›½å®¶å‰ 10 æ¡
          top10_lines = []
          for country_code in country_ips:
              top10_lines.extend(country_ips[country_code][:10])
          print(f"ç”Ÿæˆ {len(top10_lines)} æ¡è®°å½•")

          # ä¿å­˜åˆ° top10.txt
          try:
              with open('top10.txt', 'w', encoding='utf-8') as f:
                  f.write('\n'.join(top10_lines) + '\n')
              print("top10.txt å·²ç”Ÿæˆ")
          except IOError as e:
              print(f"å†™å…¥æ–‡ä»¶å¤±è´¥: {e}")
              exit(1)

          if not top10_lines:
              print("è­¦å‘Š: top10_lines ä¸ºç©ºï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜")
          EOF

      - name: Run format script
        run: python format_ip.py

      - name: Commit and push changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add top10.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --cached --quiet; then
              echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
              exit 0
          fi
          
          git commit -m "Update top10.txt with formatted IP list"
          git push
